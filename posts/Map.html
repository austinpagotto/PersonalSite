<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Ottawa Permits</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js"></script>
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@5/turf.min.js"></script>

    <script
      src="https://code.jquery.com/jquery-3.4.1.js"
      integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
      crossorigin="anonymous"
    ></script>
    <!-- <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.2.0/mapbox-gl-geocoder.min.js'></script> -->
    <!-- <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.2.0/mapbox-gl-geocoder.css' type='text/css' /> -->
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      mapboxgl.accessToken =
        "pk.eyJ1IjoiYXBhZ290dG8iLCJhIjoiY2pwNzh0NjYxMW1ndDNxbnJ4Zmd0cnZ4cCJ9.-eIh1Yhfl7R1Q2rtX6lqAQ";
      const map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/apagotto/cjw8e4f7y5ki61co3ntohays3",
        center: [-75.693362, 45.445191],
        zoom: 11,
        minZoom: 10
      });

      let url =
        "https://raw.githubusercontent.com/austinpagotto/MapboxApp/master/ottPermits.geojson";

      $.get(url, function(data) {
        //test if data is JSON
        if (typeof data == "object") {
          var fc = data;
        } else {
          var fc = JSON.parse(data);
        }
        // console.log(fc);

        map.on("load", function() {
          map.addSource("Permits", {
            type: "geojson",
            data: fc
          });
          map.addLayer({
            id: "Permits",
            type: "circle",
            source: "Permits",
            layout: {
              visibility: "visible"
            },
            paint: {
              "circle-radius": ["interpolate", ["linear"], ["zoom"], 2, 3],
              "circle-color": "rgb(30, 144, 255)"
            }
          });
        });
        map.on("click", function(e) {
          let mapLayer = map.getLayer("Buffer");
          let withinMapLayer = map.getLayer("within");

          let point = turf.point([e.lngLat.lng, e.lngLat.lat]);
          let buffered = turf.buffer(point, 2);
          let within = turf.featureCollection(
            fc.features.filter(function(address) {
              if (turf.distance(address, point) < 1.4) return true;
            })
          );

          // console.log(within.features.map(addr => turf.distance(addr,point)));
          console.log(within.features.map(addr => addr.properties['CONTRACTOR '] + '-' + addr.properties['FULLADDR']))

          if (mapLayer !== undefined) {
            map.removeLayer("Buffer").removeSource("Buffer");
          }

          if (withinMapLayer !== undefined) {
            map.removeLayer("within").removeSource("within");
          }

          map.addSource("Buffer", {
            type: "geojson",
            data: buffered
          });
          map.addLayer({
            id: "Buffer",
            type: "fill",
            source: "Buffer",
            paint: {
              "fill-opacity": 0.3,
              "fill-color": "#8e1eff",
              "fill-outline-color": "#fffe1e"
            }
          });
          map.addSource("within", {
            type: "geojson",
            data: within
          });
          map.addLayer({
            id: "within",
            type: "circle",
            source: "within",
            layout: {
              visibility: "visible"
            },
            paint: {
              // "circle-radius": ["interpolate", ["linear"], ["zoom"], 2, 3],
              "circle-color":  "#fffe1e"
            }
          });
        });
      });
      let popup = new mapboxgl.Popup();

      map.on("mousemove", function(e) {
        var features = map.queryRenderedFeatures(e.point, {
          layers: ["Permits"]
        });
        if (!features.length) {
          popup.remove();
          return;
        }
        var feature = features[0];

        popup
          .setLngLat(feature.geometry.coordinates)
          .setHTML(
            feature.properties.FULLADDR +
              "<br> " +
              feature.properties["CONTRACTOR "] +
              "<br>" +
              feature.properties["ISSUED DATE"]
          )
          .addTo(map);

        map.getCanvas().style.cursor = features.length ? "pointer" : "";
      });

      // map.on("click", function(e) {
      //   let point = turf.point([e.lngLat.lng, e.lngLat.lat]);
      //   let buffered = turf.buffer(point,2);
      //   let mapLayer = map.getLayer('Buffer');

      //   let distance = turf.distance(point,fc[1])
      //   console.log(distance)

      //   if (mapLayer !== undefined){
      //     map.removeLayer('Buffer').removeSource('Buffer');
      //   }

      //   map.addSource("Buffer", {
      //     type: "geojson",
      //     data: buffered
      //   });
      //   map.addLayer({
      //     id: "Buffer",
      //     type: "fill",
      //     source: "Buffer",
      //     paint: {
      //       "fill-opacity": 0.3,
      //       "fill-color": "#8e1eff",
      //       "fill-outline-color": "#fffe1e"
      //     }
      //   });
      // });

      // map.on("load", function() {
      //   map.addSource('Ottawa',{
      //     type:'geojson',
      //     data:"https://raw.githubusercontent.com/austinpagotto/MapboxApp/master/ottPermits.geojson"
      //   })
      //   map.addLayer({
      //     'id' :'Ottawa',
      //     'type': "circle",
      //     'source':
      //       'Ottawa',
      //     'layout': {
      //       'visibility': "visible"
      //     },
      //     'paint': {
      //       "circle-radius": ["interpolate", ["linear"], ["zoom"], 2, 3],
      //       "circle-color": "rgb(30, 144, 255)"
      //     },
      //   });

      //   map.addSource("buffer", {
      //     type: "geojson",
      //     data: {
      //       type: "FeatureCollection",
      //       features: []
      //     }
      //   });
      // });

      // let popup = new mapboxgl.Popup();

      // map.on("mousemove", function(e) {
      //   var features = map.queryRenderedFeatures(e.point, {
      //     layers: ["Ottawa"]
      //   });
      //   if (!features.length) {
      //     popup.remove();
      //     return;
      //   }
      //   var feature = features[0];

      //   popup
      //     .setLngLat(feature.geometry.coordinates)
      //     .setHTML(
      //       feature.properties.FULLADDR +
      //         "<br> " +
      //         feature.properties["CONTRACTOR "] +
      //         "<br>" +
      //         feature.properties["ISSUED DATE"]
      //     )
      //     .addTo(map);

      //   map.getCanvas().style.cursor = features.length ? "pointer" : "";
      // });

      // map.on("click", function(e) {
      //   let Address = map.queryRenderedFeatures(e.point, {
      //     layers: ["Ottawa"]
      //   });
      //   console.log(e.point)
      // });

      // let Addresses = map.queryRenderedFeatures(turf.buffer(Address[0],2).geometry.coordinates,{layers:['Ottawa']})
      // let buffer = ''

      // if (!buffer) {
      //   let clickedAddress = Address[0];
      //   let buffer = turf.buffer(clickedAddress, 2);
      //   console.log(Addresses)
      //   // let ptsWithin = turf.tag(Addresses,buffer);
      //   // console.log(ptsWithin)

      //   map.getSource("buffer").setData({
      //     type: "FeatureCollection",
      //     features: [buffer]
      //   });

      //   map.addLayer({
      //     id: "buffer",
      //     type: "fill",
      //     source: "buffer",
      //     paint: {
      //       "fill-opacity": 0.3,
      //       "fill-color": "#8e1eff",
      //       "fill-outline-color": "#fffe1e"
      //     }
      //   });
      // }
      // });
      // map.addControl(new MapboxGeocoder({
      // accessToken: mapboxgl.accessToken,
      // mapboxgl: mapboxgl
      // }));

      // map.on('load',function(){
      //             var popup = new mapboxgl.Popup({
      //                 closeButton: false,
      //                 closeOnClick : false
      //             });
      //               function showPopup(e) {
      //                 // Updates the cursor to a hand (interactivity)
      //                 map.getCanvas().style.cursor = 'pointer';

      //                 // Show the popup at the coordinates with some data
      //                 popup.setLngLat(e.features[0].geometry.coordinates)
      //                 .setHTML(checkEmpty("<p class = 'Popup'>" + e.features[0].properties.StreetNumber + ' '+ e.features[0].properties.StreetName + '</p>'))
      //                 .addTo(map);
      //             }
      //               function hidePopup() {
      //                 map.getCanvas().style.cursor = '';
      //                 popup.remove();
      //             }

      //             function checkEmpty(info) {
      //                 return (info) ? info : "No data";
      //             }

      //             map.on('mouseenter', 'ottawa-flood', showPopup);
      //             map.on('mouseleave', 'ottawa-flood', hidePopup);
      //             });
    </script>
  </body>
</html>
